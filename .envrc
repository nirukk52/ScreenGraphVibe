# direnv configuration for ScreenGraphVibe
# - Auto-load per-worktree ports from .worktree-ports
# - Load envs from .env files (root, backend, ui)
# - Default mock mode ON for all worktrees
# - Auto-activate agent venv if present

set -e

# Load stdlib (dotenv function)
if declare -F dotenv >/dev/null 2>&1; then :; else
  echo "direnv stdlib not available; please update direnv" >&2
fi

# Helper: load .env if it exists
dotenv_if_exists() {
  local file="$1"
  if [ -f "$file" ]; then
    dotenv "$file"
  fi
}

# 1) Load per-worktree ports descriptor
if [ -f .worktree-ports ]; then
  # shellcheck disable=SC1090
  source .worktree-ports
fi

# Defaults if not provided
export BACKEND_PORT="${BACKEND_PORT:-3000}"
export UI_PORT="${UI_PORT:-3001}"
export AGENT_API_PORT="${AGENT_API_PORT:-8000}"

# 2) Load env files (root, backend, ui) with later ones able to override
dotenv_if_exists .env
dotenv_if_exists backend/.env
dotenv_if_exists ui/.env

# 3) Derived envs for consistency
export AGENT_HOST="${AGENT_HOST:-0.0.0.0}"
export AGENT_PORT="${AGENT_PORT:-$BACKEND_PORT}"
export NEXT_PUBLIC_AGENT_URL="${NEXT_PUBLIC_AGENT_URL:-http://localhost:${BACKEND_PORT}}"
export NEXT_PUBLIC_APP_URL="${NEXT_PUBLIC_APP_URL:-http://localhost:${UI_PORT}}"

# 4) Mock mode ON by default (can be overridden in backend/.env)
export MOCK_FEATURES="${MOCK_FEATURES:-health/check,app-launch-config/list}"

# 5) Auto-activate agent venv if present
if [ -d "screengraph-agent/venv" ] && [ -f "screengraph-agent/venv/bin/activate" ]; then
  # shellcheck disable=SC1090
  source "screengraph-agent/venv/bin/activate"
fi

echo "[direnv] Ports â†’ backend:${BACKEND_PORT} ui:${UI_PORT} agent:${AGENT_API_PORT} | MOCK_FEATURES=${MOCK_FEATURES}"

